<!DOCTYPE html>
<html>
<meta charset="utf-8">
<title>Cadence</title>
<!--
<link href='http://fonts.googleapis.com/css?family=Parisienne|Oxygen+Mono|PT+Mono|Offside|Nova+Mono|Averia+Serif+Libre|Alex+Brush|Autour+One|Share+Tech+Mono|Merriweather|Maven+Pro|Raleway' rel='stylesheet' type='text/css'>
-->
<!-- todo: why doesn't fork me float? -->
<link href="http://fonts.googleapis.com/css?family=Cutive+Mono|Sorts+Mill+Goudy|Mate|Oxygen+Mono|Offside|Raleway:400,700" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Sorts+Mill+Goudy">
<link rel="stylesheet" type="text/css" href="css/syntax.css">
<link rel="stylesheet" type="text/css" href="css/cadence.css">
<body><a href="https://github.com/bigeasy/cadence/"><img style="position: fixed; top: 0; left: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_left_gray_6d6d6d.png" alt="Fork me on GitHub"></a><div class="container">

<div class="unit welcome">
<h1>Cadence</h1>
</div>
<!-- todo: code font is too small for body text font -->
<div class="unit description markdown"><p>Cadence builds an asynchronous function with an error-first signature. It uses a
single <code>step</code> method to express all the control flows you&#39;ve come to expect from
a control flow library.</p>
<p>Here&#39;s a function that will delete a file if it exists.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">cadence</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cadence&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>

<span class="kd">var</span> <span class="nx">deleteIf</span> <span class="o">=</span> <span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">file</span><span class="p">),</span> <span class="nx">step</span><span class="p">())</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">files</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">files</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">f</span> <span class="o">==</span> <span class="nx">file</span> <span class="p">}).</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">[</span> <span class="nx">step</span><span class="p">,</span> <span class="kc">false</span> <span class="p">]</span>
        <span class="p">}</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span> <span class="kc">true</span> <span class="p">]</span>
    <span class="p">})</span>
<span class="p">})</span>

<span class="nx">deleteIf</span><span class="p">(</span><span class="s1">&#39;junk.txt&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">deleted</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;junk.txt: was deleted &#39;</span> <span class="o">+</span> <span class="nx">deleted</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<p>A better way of doing this would be to try to delete the file, but catch an
<code>ENOENT</code> error if it doesn&#39;t exist.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">cadence</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cadence&#39;</span><span class="p">),</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>

<span class="kd">var</span> <span class="nx">deleteIf</span> <span class="o">=</span> <span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
    <span class="p">},</span> <span class="sr">/^ENOENT$/</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span> <span class="nx">step</span><span class="p">,</span> <span class="kc">false</span> <span class="p">]</span>
    <span class="p">}],</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span> <span class="kc">true</span> <span class="p">]</span>
    <span class="p">})</span>
<span class="p">})</span>

<span class="nx">deleteIf</span><span class="p">(</span><span class="s1">&#39;junk.txt&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">deleted</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;junk.txt: was deleted &#39;</span> <span class="o">+</span> <span class="nx">deleted</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<p>In the above we use a catch block to catch an <code>ENOENT</code> error and return false,
otherwise return true. If an error other than <code>ENOENT</code> is raised, the the error
will be passed as the first argument.</p>
<p>Note that for the simple examples, the simple solution is often as simple as
Cadence, but not simpiler.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">deleteIf</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s1">&#39;ENOENT&#39;</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
            <span class="k">else</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="nx">deleteIf</span><span class="p">(</span><span class="s1">&#39;junk.txt&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">deleted</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;junk.txt: was deleted &#39;</span> <span class="o">+</span> <span class="nx">deleted</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<p>Cadence can express all manner of asynchronous operations, including:</p>
<ul>
<li>serial asynchronous operations, natch</li>
<li>parallel operations</li>
<li>while loops, do..while loops, or counted loops</li>
<li>each loops that can either map or reduce an array</li>
<li>single, streaming events and error event handlers</li>
<li>asynchronous try and catch exception handling</li>
<li>asynchronous finalizers for clean up</li>
</ul>
<p>You can use Cadence in the browser too. It is not Node.js dependent and it
minzips to ~2.25k.</p>
<h3>Cadence Basics</h3>
<p>We call the series of functions a <strong><em>cadence</em></strong>. We call an individual function
in a cadence a <strong><em>step</em></strong>. Within a step we create <strong>callbacks</strong>.</p>
<p>A step can either return a value directly using the
<code>return</code> statement, or else it can return values asynchronously. </p>
<p>We use the <code>step</code> function to both define cadences
and to create the callbacks that will take us from one step to the next.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="c1">// Create an asynchronous function.</span>
<span class="kd">var</span> <span class="nx">cat</span> <span class="o">=</span> <span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">__filename</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">})</span>

<span class="c1">// Use it in your program.</span>
<span class="nx">cat</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span> <span class="p">})</span>
</pre></div>
</code></pre>
<h3>The Needlessly Confusing Bit: <code>step</code> v. <strong>step</strong></h3>
<p>Forgive me dear developer, but I&#39;ve come to call our univeral builder function
<code>step</code>, but I also use the word step to describe the anonymous functions that
compose a cadence.</p>
<p>I&#39;ll refer to the universal builder function as the <code>step</code> function, but I&#39;ll use
used the word <strong>step</strong> in bold to refer to a <strong>step</strong> in a <strong>cadence</strong>.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">cat</span> <span class="o">=</span> <span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>      <span class="c1">// &lt;- Step one.</span>

        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">__filename</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// &lt;- Step two.</span>

        <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>

    <span class="p">})</span>    <span class="c1">// &lt;- And that&#39;s a Cadence!</span>

<span class="p">})</span>
</pre></div>
</code></pre>
<p>I&#39;ve considered using <code>$</code> in lieu of <code>step</code> so that it is all sigils all the
time, but the code gets so squiggly. The universal builder function needs a name
to distinquish it from all the syntax hacks. That name is <code>step</code>.</p>
<p>The <code>step</code> function is used to create cadences and callbacks.</p>
<p>The result of the callback invoked by <code>step()</code> is passed to the next step in the
cadence. The next step does not expect an error as its first argument. If there
is an error, the error is propagated up and out to caller&#39;s callback.</p>
<h2>Cadence Step by Step</h2>
<p>In our examples we are going to use a function called echo which will invoke the
callback with the arguments given.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">echo</span> <span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>Cadence exports a single function which by convention is named <code>cadence</code>.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">cadence</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cadence&#39;</span><span class="p">),</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>

<span class="kd">var</span> <span class="nx">find</span> <span class="o">=</span> <span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">$</span><span class="p">())</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">list</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">})</span>

<span class="kd">function</span> <span class="nx">isJavaScript</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="sr">/\.js$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">find</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="nx">isJavaScript</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">found</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">found</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39; contains a JavaScript file.&#39;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<p>Let&#39;s look closer at the <code>find</code> function.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">find</span> <span class="o">=</span> <span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">$</span><span class="p">())</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">list</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<p>The find function is returned by calling <code>cadence</code>. The <code>cadence</code> function will
build a function that, when invoked, will call the function body.</p>
<p>The first argument is a universal builder function. We&#39;ve named it <code>$</code> for
brevity, but you can name it whatever you&#39;d like.</p>
<p>The universal builder function is invoked with a series of functions. The
creates a <strong>cadence</strong>. Each function is a <strong>step</strong> in the cadence.</p>
<p>The <code>cadence</code> function accepts a body function. It returns a function. The
function that it returns, when invoked, will invoke the function body.</p>
<p>The first parameter to the function body is always the magical <code>step</code> function.
The step function builds callbacks and cadences.</p>
<p>When you invoke <code>step</code> with no arguments, it builds a simple error first callback.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">calledback</span> <span class="o">=</span> <span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">echo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
<span class="p">})</span>

<span class="nx">calledback</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">equal</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;called back&#39;</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<p>When you invoke <code>step</code> with a function, it creates a cadence. Each function in
the cadence is a step in the cadence.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">stepping</span> <span class="o">=</span> <span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">echo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">$</span><span class="p">())</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">value</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="p">})</span>
<span class="p">})</span>

<span class="nx">stepping</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">equal</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;incremented&#39;</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<p>The results of one step are the arguments of the next step. The results of the
final step are the results of the cadence.</p>
<p>A step can return a value one of two ways. A step can either explicitly return a
value using a return statement or else it can pass values through a callback
created by invokeing the universal builder function.</p>
<h2>Serial and Parallel</h2>
<p>A simple distinction between serial and parallel. The functions in a cadence are
run in <strong>serial</strong>. The callbacks build by calling <code>step()</code> withing a cadence are
invoked in <strong>parallel</strong>.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="kr">double</span> <span class="o">=</span> <span class="nx">cadence</span><span class="p">(</span><span class="nx">functions</span> <span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">echo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
        <span class="nx">echo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">one</span><span class="p">,</span> <span class="nx">two</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span> <span class="nx">one</span><span class="o">:</span> <span class="nx">one</span><span class="p">,</span> <span class="nx">two</span><span class="o">:</span> <span class="nx">two</span> <span class="p">}</span>
    <span class="p">})</span>
<span class="p">})(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">one</span><span class="p">,</span> <span class="nx">two</span><span class="p">)</span> <span class="p">{</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">),</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>

<span class="kd">var</span> <span class="nx">initialize</span> <span class="o">=</span> <span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">,</span> <span class="nx">conf</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="c1">// These two operations happen in parallel.</span>
        <span class="nx">db</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">step</span><span class="p">())</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">conf</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">conf</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// The next step is called when both operations complete.</span>
        <span class="nx">conf</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span>
        <span class="nx">conn</span><span class="p">.</span><span class="nx">encoding</span> <span class="o">=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">encoding</span> <span class="o">||</span> <span class="s1">&#39;UTF-8&#39;</span>
        <span class="nx">conn</span><span class="p">.</span><span class="nx">lang</span> <span class="o">=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">lang</span> <span class="o">||</span> <span class="s1">&#39;en_US&#39;</span>
        <span class="k">return</span> <span class="nx">conn</span> <span class="c1">// return an initialized connection.</span>
    <span class="p">})</span>
<span class="p">})</span>

<span class="nx">initialize</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span>
    <span class="nx">run</span><span class="p">(</span><span class="nx">connection</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<p>A step inside a cadence can contain callbacks whose return values appear in the
next step or sub-cadences. The callbacks and sub-cadences in a step are run in
<strong>parallel</strong>, allowing you to mix and match cadences and sub-cadences to direct
the flow of your asynchronous program.</p>
<p>Note that Cadence is as terse as it can be. Yes, you must still use callbacks,
but it avoids the temple of doom by keeping your callbacks in line, one after
the other. It works hard so that indentation reflects a logical nesting of your
program into parallel operations, instead of having a nesting for each and every
callback.</p>
<h3>TODO</h3>
<p>Note that it is simple to create sub-routines within your library using cadence.
Instead of passing a callback, pass the step function. A sub-cadence in the step
function will return to the next step in the caller&#39;s cadence.</p>
<h3>Cadences Within Steps Within Cadences</h3>
<p>You can define a cadence within a step. This let&#39;s you work with results of an
asynchronous call.</p>
<p>Let&#39;s say that we want to get a <code>stat</code> object, but include the body of the file
in the <code>stat</code> object. When we get our <code>stat</code> object, we can use a sub-cadence to
complete the <code>stat</code> object by reading the body.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">cadence</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cadence&#39;</span><span class="p">),</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>    <span class="c1">// sub-cadence</span>
            <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
        <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">stat</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">body</span>
            <span class="k">return</span> <span class="nx">stat</span><span class="p">;</span>
        <span class="p">})</span>
    <span class="p">})</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<p>In the above example, we create a sub-cadence so that we can read in the file
body and add it to the <code>stat</code> object. The sub-cadence allows us to update the
<code>stat</code> object asynchronously. It is in the scope of callback step invoked after
we read the file body with <code>fs.readFile</code>.</p>
<p>Here&#39;s how we would use this module.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">bodyStat</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./body-stat&#39;</span><span class="p">)</span>

<span class="nx">bodyStat</span><span class="p">(</span><span class="nx">__filename</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Content-Length: &#39;</span> <span class="o">+</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nx">conosle</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">stat</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<h3>Here&#39;s a Tour Guide Function; Echo</h3>
<p>For the sake of our tour, let&#39;s implement an asynchronous function that we can
use to exercise Cadence. All it does is wait a bit, then invoke our callback.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">echo</span> <span class="p">(</span><span class="nx">parameter</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">setImmediate</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">parameter</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>Let&#39;s use echo to illustrate the many difference flows possible with cadence.</p>
<h3>Subsequent Arguments</h3>
<p>When you create callbacks in a Cadence step, the results are passed onto the
subsequent step. If you create multiple callbacks, the subsequent step will
receive the results in order.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="nx">echo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
        <span class="nx">echo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">equal</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;first&#39;</span><span class="p">)</span>
        <span class="nx">equal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">)</span>

    <span class="p">})</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<p>The order of the callbacks determines the order of of the arguments.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">first</span> <span class="o">=</span> <span class="nx">step</span><span class="p">()</span>
        <span class="kd">var</span> <span class="nx">second</span> <span class="o">=</span> <span class="nx">step</span><span class="p">()</span>

        <span class="nx">echo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">second</span><span class="p">)</span>
        <span class="nx">echo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">first</span><span class="p">)</span>

    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">equal</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;first&#39;</span><span class="p">)</span>
        <span class="nx">equal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">)</span>

    <span class="p">})</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<p>In the above example, observe that the declaration order determines argument
order, not the order of invocation of the callbacks. Even if <code>second</code> is called
back before <code>first</code>, the argument to first in the subsequent step is invoked with
the results of <code>first</code> as the first argument <code>a</code>, and <code>second</code> as the second argument
<code>b</code>.</p>
<p>TK: More words and examples here.
TK: Example using <code>fs</code>.
TK: Always use an initial sub-cadence in the <code>README.md</code> so people don&#39;t get to
thinking that it is something to be avoided.
TK: In the sub-cadence example, talk about scope and closure.
TK: Move up a section.</p>
<p>Sometimes you don&#39;t have an asynchronous function to invoke. You can return a
a value to be used as the arguments for the subsequent step.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">one</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">equal</span><span class="p">(</span><span class="nx">one</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;returned&#39;</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<p>This happens quite often actually. Sometimes you&#39;ve already invoked the
asynchronous function and have a copy of the result. Other times you want to do
some synchronous processing of the result of an asynchronous call. The example
below illustrates both cases.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span> <span class="nx">config</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="k">return</span> <span class="nx">config</span>
        <span class="k">else</span> <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;./config.json&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
        <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">})</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<p>Returning an array is a special case. When you return an array the elements of
the array are used as the arguments to the subsequent function.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">]</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">one</span><span class="p">,</span> <span class="nx">two</span><span class="p">,</span> <span class="nx">three</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">equal</span><span class="p">(</span><span class="nx">one</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;returned one&#39;</span><span class="p">)</span>
        <span class="nx">equal</span><span class="p">(</span><span class="nx">two</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;returned two&#39;</span><span class="p">)</span>
        <span class="nx">equal</span><span class="p">(</span><span class="nx">three</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;returned three&#39;</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<p>What if you want to return an array as the sole argument to the subsequent
function? Then put the array in an array as the sole element.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">]</span> <span class="p">]</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">equal</span><span class="p">(</span><span class="nx">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;element one&#39;</span><span class="p">)</span>
        <span class="nx">equal</span><span class="p">(</span><span class="nx">array</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;element two&#39;</span><span class="p">)</span>
        <span class="nx">equal</span><span class="p">(</span><span class="nx">array</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;element three&#39;</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<h3>Catching Errors</h3>
<p>Cadence encourages parallelism, and because parallel operations can also
fail in parallel and/or raise many exceptions in parallel (fun stuff),
its internal error handling mechanism deals with arrays of errors.</p>
<p>Externally, however, your caller is expecting one single error, because Cadence
builds a function that follows the error-first callback standard. Thus, even
when there are many errors, the default is to return the first error that occurs
in the cadence.</p>
<p>When an error occurs, Cadence waits for all parallel operations to complete,
then it raises the error along with any other errors that occured in parallel.
If you want to catch these errors, create a try/catch function pair by wrapping
it in an array.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="c1">// Do something stupid.</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/shadow&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">errors</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Catch the exception.</span>
        <span class="nx">ok</span><span class="p">(</span><span class="nx">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">code</span> <span class="o">==</span> <span class="s1">&#39;EACCES&#39;</span><span class="p">,</span> <span class="s1">&#39;caught EACCES&#39;</span><span class="p">)</span>
        <span class="nx">ok</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;caught EACCES and only EACCES&#39;</span><span class="p">)</span>

    <span class="p">}])</span>
<span class="p">})()</span>
</pre></div>
</code></pre>
<p>In the above, we catch the <code>EACCES</code> that is raised when we attempt to read a
read-protected file. Note the array that binds the catch function to the step
that proceeds it.</p>
<p>If no error occurs, the catch function is not invoked. The next function in the
cadence after the try/catch pair is invoked with the successful result of the
try function.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="c1">// Read a readable file.</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/hosts&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">errors</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// This will not be called.</span>
        <span class="nx">proecss</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;Hosts file is missing!\n&#39;</span><span class="p">)</span>

    <span class="p">}],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">hosts</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">hosts</span><span class="p">)</span>

    <span class="p">})</span>
<span class="p">})()</span>
</pre></div>
</code></pre>
<p>When an error triggers the catch function, the catch function can recover and
continue the cadence by returning normally.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="c1">// Read file that might be missing.</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">HOME</span> <span class="o">+</span> <span class="s1">&#39;/.config&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">errors</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// That didn&#39;t work, for whatever reason, so try the global.</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/config&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

    <span class="p">}],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

    <span class="p">})</span>
<span class="p">})()</span>
</pre></div>
</code></pre>
<p>Also note that both the try function and error function can use sub-cadences,
arrayed cadences, fixups, etc.; everything that Cadence has to offer.</p>
<p>A catch function also catches thrown exceptions.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;thrown&#39;</span><span class="p">)</span>

    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">errors</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">ok</span><span class="p">(</span><span class="nx">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">message</span> <span class="o">==</span> <span class="s1">&#39;thrown&#39;</span><span class="p">,</span> <span class="s1">&#39;caught thrown&#39;</span><span class="p">)</span>
        <span class="nx">ok</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;caught thrown and only thrown&#39;</span><span class="p">)</span>

    <span class="p">}])</span>
<span class="p">})()</span>
</pre></div>
</code></pre>
<p>Errors are provided in an <code>errors</code> array. Why an array, again? Because with Cadence,
you&#39;re encouraged to do stupid things in parallel.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="c1">// Read two read-protected files.</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/shadow&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/sudoers&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">errors</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">ok</span><span class="p">(</span><span class="nx">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">code</span> <span class="o">==</span> <span class="s1">&#39;EACCES&#39;</span><span class="p">,</span> <span class="s1">&#39;caught EACCES&#39;</span><span class="p">)</span>
        <span class="nx">ok</span><span class="p">(</span><span class="nx">errors</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">code</span> <span class="o">==</span> <span class="s1">&#39;EACCES&#39;</span><span class="p">,</span> <span class="s1">&#39;caught another EACCES&#39;</span><span class="p">)</span>
        <span class="nx">ok</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;caught two EACCES&#39;</span><span class="p">)</span>

    <span class="p">}])</span>
<span class="p">})()</span>
</pre></div>
</code></pre>
<p>Note that the errors are indexed in the <strong>order in which they were caught</strong>,
not in the order in which their callbacks were declared.</p>
<p>The second argument to a function callback is the first error in the errors
array. This is in case you&#39;re certain that you&#39;ll only ever get a single error,
and the array subscript into the <code>errors</code> array displeases you.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/shadow&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">errors</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">ok</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s1">&#39;EACCES&#39;</span><span class="p">,</span> <span class="s1">&#39;caught EACCES&#39;</span><span class="p">)</span>

    <span class="p">}])</span>
<span class="p">})()</span>
</pre></div>
</code></pre>
<p>For the sake of style, when you don&#39;t want to reference the errors array, you
can of course hide it using <code>_</code> or, if that is already in use, double <code>__</code>.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/shadow&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">ok</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s1">&#39;EACCES&#39;</span><span class="p">,</span> <span class="s1">&#39;caught EACCES&#39;</span><span class="p">)</span>

    <span class="p">}])</span>
<span class="p">})()</span>
</pre></div>
</code></pre>
<h3>Propagating Errors</h3>
<p>You can propagate all of the caught errors by throwing the <code>errors</code> array.</p>
<p>Imagine a system where sudo is not installed (as is the case with a base
FreeBSD.)</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="c1">// Read two read-protected files.</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/sudoers&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/shadow&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">errors</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Maybe sudo isn&#39;t installed and we got `ENOENT`?</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">errors</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s1">&#39;EACCES&#39;</span> <span class="p">}))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nx">errors</span>
        <span class="p">}</span>

    <span class="p">}])</span>
<span class="p">})(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Only the first exception raised is reported to the caller.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>

<span class="p">})</span>
</pre></div>
</code></pre>
<p>You can also just throw an exception of your chosing.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="c1">// Read two read-protected files.</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/sudoers&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/shadow&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">errors</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Maybe sudo isn&#39;t installed and we got `ENOENT`?</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">errors</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s1">&#39;EACCES&#39;</span> <span class="p">}))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;something bad happened&#39;</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="p">}])</span>
<span class="p">})(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">ok</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="s1">&#39;something bad happened&#39;</span><span class="p">)</span>

<span class="p">})</span>
</pre></div>
</code></pre>
<p>When you raise an error in a catch function, it cannot be caught in the current
cadence. You can still catch it in a calling cadence, however.</p>
<p>Here we log any errors before raising them all up to the default handler:</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

            <span class="c1">// Read two read-protected files.</span>
            <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/sudoers&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
            <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/shadow&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

        <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">errors</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// Maybe sudo isn&#39;t installed and we got `ENOENT`?</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">errors</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s1">&#39;EACCES&#39;</span> <span class="p">}))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nx">errors</span>
            <span class="p">}</span>

        <span class="p">}])</span>
  <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">errors</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">errors</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">})</span>
      <span class="k">throw</span> <span class="nx">errors</span>

  <span class="p">}])</span>
<span class="p">})(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">ok</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="s1">&#39;got a single error&#39;</span><span class="p">)</span>

<span class="p">})</span>
</pre></div>
</code></pre>
<p>As you can see, Cadence will catch exceptions as well as handle errors passed to
callbacks.</p>
<h3>Conditional Error Handling</h3>
<p>Dealing with an array of errors means you&#39;re almost always going to want to
filter the array to see if it contains the error you&#39;re expecting, and which error
that might be. Because this is so common, it&#39;s built into Cadence.</p>
<p>To create a try/catch pair that will respond only to certain errors, add a
regular expression between the try function and the catch function.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="c1">// Read file that might be missing.</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">HOME</span> <span class="o">+</span> <span class="s1">&#39;/.config&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

    <span class="p">},</span> <span class="sr">/^ENOENT$/</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="c1">// That didn&#39;t work because the file does not exist, try the global.</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/config&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

    <span class="p">}],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

    <span class="p">})</span>
<span class="p">})()</span>
</pre></div>
</code></pre>
<p>In the above example, we only catch an exception if the <code>code</code> property matches
/ENOENT/. If there is a different error- say, the file exists but we can&#39;t
read it- that error is not caught by our try/catch pair.</p>
<p>The condition is tested against the <code>code</code> property if it exists. If it doesn&#39;t
exist then it is tested against the <code>message</code> property.</p>
<p>You can easily test for multiple error codes using a regular expression, as
well. Here we test for both <code>EACCES</code> and <code>ENOENT</code>.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/sudoers&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/shadow&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

    <span class="p">},</span> <span class="sr">/^(EACCES|ENOENT)$/</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">errors</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">ok</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;handled&#39;</span><span class="p">)</span>

    <span class="p">}])</span>
<span class="p">})()</span>
</pre></div>
</code></pre>
<p>You can also be explicit about the property used to test by adding the name of
that property between the try function and the condition. Here we explicitly
state that the <code>code</code> property is the property to test.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/sudoers&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/shadow&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

    <span class="p">},</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="sr">/^(EACCES|ENOENT)$/</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">errors</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">ok</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;handled&#39;</span><span class="p">)</span>

    <span class="p">}])</span>
<span class="p">})()</span>
</pre></div>
</code></pre>
<p>If the condition does not match all the examples raised, then the catch function
is not invoked, and the errors are propagated.</p>
<p>However, if the errors are not caught and propagated out of Cadence and to the
caller, then the caller will receive the first exception that did not match the
conditional.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="nx">step</span><span class="p">()(</span><span class="kc">null</span><span class="p">,</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/sudoers&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/etc/shadow&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

    <span class="p">},</span> <span class="sr">/^(EACCES|ENOENT)$/</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">errors</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">ok</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;handled&#39;</span><span class="p">)</span>

    <span class="p">}])</span>
<span class="p">})()</span>
</pre></div>
</code></pre>
<p>Why? Because we can only return one exception to the caller, so it is better to
return the unexpected exception that caused the condition to fail, even if it
was not the first exception raised by the Cadence. It makes it clear that the
condition is failing because of additional errors.</p>
<p>TK: Throwing errors resets the concept of unmatched.</p>
<h4>Error Catching Example</h4>
<p>Let&#39;s extend our <code>deleteIf</code> function. Let&#39;s say that if the file doesn&#39;t exist,
we ignore the error raised when we stat the file. To catch the error we wrap our
call to <code>stat</code> in a try/catch function pair. If the call to <code>stat</code> results in
<code>ENOENT</code>, our catch function is called. The catch function simply returns early
because ther is no file to delete.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="c1">// Use Cadence.</span>
<span class="kd">var</span> <span class="nx">cadence</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cadence&#39;</span><span class="p">),</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>

<span class="c1">// Delete a file if it exists and the condition is true.</span>
<span class="kd">var</span> <span class="nx">deleteIf</span> <span class="o">=</span> <span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">condition</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>

    <span class="p">},</span> <span class="sr">/^ENOENT$/</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// TK: Early return example can be if it is a directory, return early.</span>
        <span class="nx">step</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>

    <span class="p">}],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">stat</span> <span class="o">&amp;&amp;</span> <span class="nx">condition</span><span class="p">(</span><span class="nx">stat</span><span class="p">))</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="nx">step</span><span class="p">())</span>

    <span class="p">})</span>
<span class="p">})</span>

<span class="c1">// Test to see if a file is empty.</span>
<span class="kd">function</span> <span class="nx">empty</span> <span class="p">(</span><span class="nx">stat</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">}</span>

<span class="c1">// Delete a file if it exists and is empty.</span>
<span class="nx">deleteIf</span><span class="p">(</span><span class="nx">__filename</span><span class="p">,</span> <span class="nx">empty</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span> <span class="p">})</span>
</pre></div>
</code></pre>
<p>We test to see if the error is <code>ENOENT</code>. If not, we have a real problem, so we
throw the error. The throw is caught and forwarded to the callback that invoked
the cadence function.</p>
<p>If the error is <code>ENOENT</code>, we exit early by calling the step function directly as
a if it were itself an error/result callback, passing <code>null</code> to indicate no
error.</p>
<h2>Working with Events</h2>
<p>Cadence also works with event emitting objects that do not accept an error as
the first parameter. These are event mechanisms like the DOM events or the
events generated by the Node.js <code>EventEmitter</code>.</p>
<p>To indicate that you want an event handler, use <code>-1</code> as the first parameter to
the <code>step</code> function.</p>
<p>Why is <code>-1</code> the mnemonic for an event? Think of the the <code>-1</code> as a shift of
sorts, we&#39;re moving things to the left by one. Negative numbers are to the left.
Isn&#39;t syntax bashing fun?</p>
<p>Here is a unit test for working with <code>EventEmitter</code> illustrating the use of
events in Cadence.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">cadence</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cadence&#39;</span><span class="p">),</span> <span class="nx">event</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">ee</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">event</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">()</span>

<span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">,</span> <span class="nx">ee</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">ee</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="nx">ee</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="nx">ee</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">(</span><span class="nb">Error</span><span class="p">))</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">])</span>
    <span class="p">})</span>
<span class="p">})(</span><span class="nx">emitter</span><span class="p">)</span>

<span class="nx">ee</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">ee</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="nx">ee</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

<span class="nx">ee</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
</pre></div>
</code></pre>
<p>Below we use the example of splitting an HTTP server log for many hosts
into a log file for each host.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">cadence</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cadence&#39;</span><span class="p">),</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>

<span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">readable</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readableStream</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/logins.txt&#39;</span><span class="p">)</span>
        <span class="nx">readable</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="nx">readable</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">.</span><span class="nx">event</span><span class="p">([]))</span>
        <span class="nx">readable</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">hosts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">).</span><span class="nx">foreach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="sr">/^([\w\d.]+)\s+(.*)/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">line</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">(</span><span class="nx">hosts</span><span class="p">[</span><span class="nx">host</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="nx">hosts</span><span class="p">[</span><span class="nx">host</span><span class="p">])).</span><span class="nx">push</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
        <span class="p">})</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">host</span> <span class="k">in</span> <span class="nx">hosts</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">writable</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">writableStream</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">host</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span><span class="p">)</span>
            <span class="nx">writable</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">hosts</span><span class="p">[</span><span class="nx">host</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">)</span>
            <span class="nx">writable</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;drain&#39;</span><span class="p">,</span> <span class="nx">step</span><span class="p">.</span><span class="nx">event</span><span class="p">())</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">})()</span>
</pre></div>
</code></pre>
<p>This is a horrible example. Try again.</p>
<p>Here&#39;s a <code>mkdirp</code>, but let&#39;s complete it.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mkdirs</span> <span class="o">=</span> <span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">,</span> <span class="nx">directory</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">directory</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">directory</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">mode</span> <span class="o">=</span> <span class="mi">0777</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="nx">process</span><span class="p">.</span><span class="nx">umask</span><span class="p">())</span>
    <span class="kd">var</span> <span class="nx">made</span> <span class="o">=</span> <span class="kc">null</span>

    <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">mkdir</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s1">&#39;ENOENT&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">mkdirp</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">directory</span><span class="p">),</span> <span class="nx">step</span><span class="p">())</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">step</span><span class="p">())</span>
            <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">stat</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">())</span> <span class="nx">step</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">}])</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<h2>Loops</h2>
<p>TK: Serial and parallel loops, but parallel doesn&#39;t really loop.</p>
<h3>Serial Loops</h3>
<p>TK: So, just Loops, then? What about Serial Each and Parallel Each?
TK: Do examples look better without commas?</p>
<p>Cadence wants you to use nesting to represent subordinate operations, so it wants
to provide you with a looping structure that is not terribily compilicated, or
nested.</p>
<p>Looping in Cadence is performed by defining a sub-cadence, then invoking the
function that is returned by the sub-cadence definition. We&#39;ll call this the
<strong>looper function</strong>. If you <strong>do not invoke</strong> the function, Cadence will start
the sub-cadence for you when your step returns and run the sub-cadence once. If
you <strong>do invoke</strong> the function, Cadence will run the sub-cadence as a loop.</p>
<p>You can create <code>while</code> loops, <code>do...while</code> loops, stepped loops and <code>forEach</code>
loops using the looper function.</p>
<h3>Endless Loops</h3>
<p>If you invoke without arguments, you will invoke an endless loop. You terminate
the loop using the <code>step(error, result)</code> explicit return.</p>
<p>Calling <code>looper()</code>.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">count</span><span class="o">++</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="nx">step</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span>
    <span class="p">})()</span> <span class="c1">//immediate invocation</span>
<span class="p">})(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span>
    <span class="nx">equal</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;loop&#39;</span><span class="p">)</span>
<span class="p">})()</span>
</pre></div>
</code></pre>
<p>When your terminal condition is the last function, you&#39;ve basically created a
<code>do...while</code> loop.</p>
<h3>Loop Initializers</h3>
<p>When an endless loop iterates, the result of the last function is passed as
arguments to the first function. You can use this to create a <code>while</code> loop.</p>
<p>To pass in an initial test value to the endless loop, you invoke the looper
function with a leading <code>null</code>, followed by the parameters, <code>looper(null, arg1,
arg2)</code> the same the way you invoke an explicit return of the <code>step</code> function.</p>
<p>Calling <code>looper(null, arg)</code>.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">more</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">more</span><span class="p">)</span> <span class="nx">step</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="nx">step</span><span class="p">()(</span><span class="kc">null</span><span class="p">,</span> <span class="o">++</span><span class="nx">count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
    <span class="p">})(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
<span class="p">})(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span>
    <span class="nx">equal</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;initialized loop&#39;</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<h3>Counted Loops</h3>
<p>You can tell Cadence to loop for a fixed number of times by invoking the loop
start function with a count of iterations.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">equal</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="s1">&#39;keeping a count for you&#39;</span><span class="p">)</span>
        <span class="nx">step</span><span class="p">()(</span><span class="kc">null</span><span class="p">,</span> <span class="o">++</span><span class="nx">count</span><span class="p">)</span>
    <span class="p">})(</span><span class="mi">10</span><span class="p">)</span>
<span class="p">})(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span>
    <span class="nx">equal</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;counted loop&#39;</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<h3>Each Loops</h3>
<p>You can invoke the loop passing it an array. The loop will be invoked once for
each element in the array, passing the array element to the first function of
the sub-cadence.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">sum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">number</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">equal</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;keeping an index for you&#39;</span><span class="p">)</span>
        <span class="nx">step</span><span class="p">()(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">sum</span> <span class="o">=</span> <span class="nx">sum</span> <span class="o">+</span> <span class="nx">number</span><span class="p">)</span>
    <span class="p">})([</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">])</span>
<span class="p">})(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span>
    <span class="nx">equal</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;reduced each loop&#39;</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<h3>Gathered Loops</h3>
<p>Both counted loops and each loops can be gathered into an array. If you pass an
initial array to the callback function, then each iteration will be gathered
into an array result.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">step</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">step</span><span class="p">()(</span><span class="kc">null</span><span class="p">,</span> <span class="o">++</span><span class="nx">count</span><span class="p">)</span>
    <span class="p">})([],</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">])</span>
<span class="p">})(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span>
    <span class="nx">deepEqual</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span> <span class="p">],</span> <span class="s1">&#39;gathered each loop&#39;</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<p>You cannot gather endless loops.</p>
<h3>Loop Labels</h3>
<p>If you want to give up early and try again, you can use a loop label. When you
invoke the looper function it returns a label object. You can use the label
object to restart the loop.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">var</span> <span class="nx">retry</span> <span class="o">=</span> <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">count</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span>
        <span class="k">else</span> <span class="nx">step</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">step</span><span class="p">(</span><span class="nx">retry</span><span class="p">)</span>
    <span class="p">}])(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">})(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span>
    <span class="nx">equal</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;loop continue&#39;</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<p>This one&#39;s tricky. Because we specified a count of <code>1</code>, the loop will only loop
once, but because we call the <code>retry</code> label when we catch an error, the loop
tries again.</p>
<h3>Loop Label Quick Returns</h3>
<p>Some of the things we document here are about style and syntax bashing that you
can do. It&#39;s not necessarily a part of Cadence.</p>
<p>Often times when working with labels, you&#39;re testing to see if you should invoke
the label when you enter a function; if not you would like to do something else.
This is going to create an <code>if/else</code> block that increases our nesting. If we
were programming synchronously in plain old JavaScript, we could call <code>continue</code>
and that would jump to the loop label.</p>
<p>To preserve that jumpy feeling, when you invoke <code>step(label)</code> it returns true,
so you can create a return using <code>&amp;&amp;</code>.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">cadence</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">retry</span> <span class="o">=</span> <span class="nx">step</span><span class="p">([</span><span class="kd">function</span> <span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;retry&#39;</span><span class="p">)</span>
        <span class="k">else</span> <span class="nx">step</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span> <span class="o">==</span> <span class="s1">&#39;retry&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">step</span><span class="p">(</span><span class="nx">retry</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">throw</span> <span class="nx">error</span>
    <span class="p">}])(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">})(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span>
    <span class="nx">equal</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;loop continue&#39;</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</code></pre>
<p>TK: Another example of this...</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">!=</span> <span class="nx">stop</span><span class="p">)</span> <span class="k">return</span> <span class="nx">step</span><span class="p">(</span><span class="nx">retry</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</code></pre>
<h2>Control Flow</h2>
<p>Here is where you would discuss <code>step.jump</code> and the function index.</p>
</div>

</div></body>
<!-- todo: move into an edify plugin -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-20388260-3', 'bigeasy.github.io');
ga('send', 'pageview');
</script>
</html>
